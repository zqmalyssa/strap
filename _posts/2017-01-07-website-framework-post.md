---
layout: post
title: 大型网站架构
tags: [code, web, design]
author-id: zqmalyssa
---

大型网站需要考虑的东西太多了，京东促销崩溃，12306春节长崩，需要有合理的全局规划设计才能解决问题

参考《大型网站技术架构》这本书

#### 大型互联网系统特点

1. 高并发，大流量
2. 高可用
3. 海量数据
4. 用户分布广泛，网络情况复杂
5. 安全环境恶劣
6. 需求快速变更，发布频繁
7. 渐进式发展

#### 大型互联网系统演进

1. 分布式数据库时网站数据库拆分的最后手段，只有在单表数据规模非常庞大的时候才使用，不到不得已时，网站更常用的数据库拆分手段是业务分库，将不同业务的数据库部署在不同的物理服务器上
2. 当对数据存储和检索的需求越发复杂时，网站需要采取一些非关系数据库技术如NoSQL和非数据库查询技术如搜索引擎

![web]({{ "/assets/img/web/web_framework.jpg" | relative_url}})

通过一段时间的进化，大型网站的技术架构大致如上图所示，最终使用了分布式架构

kubernetes是分布式的吗，是啊，应用部署在不同服务器上，K8S给我们做了这件事，分布式意味着服务调用必须通过网络，这可能会对性能造成比较严重的影响

**Web前端性能优化**

1. 浏览器访问优化
	- 减少http请求数
	- 使用浏览器缓存，Cache-Control,Expires
	- 启用压缩
	- CSS放在上面，JavaScript放在下面
	- 减少Cookie传输
2. CDN加速
3. 反向代理
	- 安全功能
	- 可以配置缓存
	- 提供负载均衡

**应用服务器性能优化**

1. 分布式缓存
	- 缓存的原理是hash表
	- 合理的使用缓存，分析好业务
	- 分布式缓存，JBoss和Memcached，后者比较有代表性，服务器之间不通信
2. 异步操作
	- 使用消息队列
3. 使用集群
4. 代码优化
	- 多线程，在使用多线程的时候，采用以下方法解决线程安全的问题，将对象设计成无状态对象，使用局部变量，并发访问资源时使用锁
	- 资源复用，单例模式，对象池
	- 数据结构
	- 垃圾回收，堆栈(stack)用于存储线程上下文信息，如方法参数，局部变量，堆则是存储对象的内存空间，对象的创建和释放，垃圾回收都在这进行。年轻代和老年代，年轻代又可划分成Eden区，From区和To区，Old Generation空间用完，就会触发Full GC，全量回收对性能影响较大


**存储性能优化**

1. 硬件，采用SSD
2. B+树和LSM树
3. RAID和HDFS
	- RAID0
	- RAID1
	- RAID10
	- RAID3
	- RAID5
	- RAID6
	- 上面有些介绍，RAID在传统关系数据库及文件系统中应用比较广泛，但大型网站中不常用
	- HDFS，hadoop的分布式文件系统，在存储集群的多台服务器上进行数据并发读写和备份，而后MapReduce处理多个block，相当于实现RAID0的并发访问功能

**高可用架构**

1. 集群环境的Session管理
	- Session复制，大型网站Session复制太频繁了，人又多
	- Session绑定，负载均衡服务器总是将来源同一IP的请求分发到同一台服务器上，会话粘滞，但就不满足高可用
	- 利用Cookie记录Session，或多或少会使用点Cookie，放一些少的信息，发送给服务器
	- Session服务器，事实上将应用服务器的状态分离，分为无状态的应用服务器和有状态的Session服务器

2. 高可用的服务
	- 幂等性设计，在服务层保证服务重复调用和调用一次产生的结果相同

**伸缩性架构**

1. IP负载均衡在内核进程完成数据分发，较反向代理负载均衡(在应用程序中分发数据)有更好的处理性能，但是由于所有请求响应都需要经过负载均衡服务器，集群的最大响应数据吞吐量不得不受制于负载均衡服务器网卡带宽，对于下载服务和视频服务这种大数据量传输就不友好了，**链路负载均衡**不像IP负载均衡那样是修改IP的，它是修改Mac地址的，这种负载均衡方式又称作直接路由方式(DR)，典型的产品是LVS

2. 分布式缓存中，路由算法也非常重要，用一致性hash算法解决分布式缓存中扩缩容的问题

3. 数据存储的伸缩性，其中又分成关系型数据库和NoSQL数据库
	- 关系型数据库，分库之后就不能用join了，分布式的话，事务就更不用谈了，目前处理较为简陋
	- NoSQL中有代表HBase，里面还用到了Zookeeper(一个支持分布式一致性的数据管理服务)，加入新的服务器，就会将负荷重的HRegion迁移过去

**可扩展架构**

1. Webservice虽然很成熟，但是缺点也很明显，臃肿的注册和发现机制，低效的XML序列化手段，开销相对较高的HTTP远程通信，复杂的部署和维护手段

2. 大型分布式服务的需求和特点
	- 负载均衡
	- 失效转移
	- 高效的远程通信
	- 整合异构系统
	- 对应用最少入侵
	- 版本管理
	- 实时监控

3. 分布式服务框架设计
	- 面向SOA(Service Oriented Architecture面向服务的体系结构)，Facebook用的是Thrift，不开源，阿里巴巴用的是Dubbo


**安全架构**

1. 基本上70%左右的Web应用攻击都来自XSS攻击和SQL注入
	- XSS攻击，跨站点脚本攻击(Cross Site Script)，发射型，诱使用户点击一个嵌入恶意脚本的连接，达到攻击的目的。持久型，论坛，博客中较为常用，防范的话，1消毒，该转义再转义，2HttpOnly，防止Cookie被窃取
	- 注入攻击，SQL注入攻击和OS注入攻击，SQL的话HTTP中带有恶意命令，解决方式也是消毒，还有参数绑定，许多ORM框架，Mybatis，Hibernate，都实现SQL预编译和参数绑定，攻击者的恶意SQL会被当做SQL的参数，而不是SQL命令被执行
	- CSRF攻击，跨站点请求伪造，防范方式1是携带token，2是验证码，3是referer check，referer域中记录了请求来源，检查此项看是否合法，很多网站使用这个功能实现图片防盗链(不是来自自己网站的网页就拒绝)


2. 信息加密技术
	- 单项散列加密，加密后值相同，密码不可逆(MD5，SHA等)
	- 对称加密，加密和解密使用的秘钥是通一个秘钥(可以相互推算)，如DES和RC算法，系统开销小，但是秘钥需要安全传输，这个丢了就没秘密可言
	- 非对称加密，非对称加密解密的秘钥不是一个，其中一个对外界公开，称作公钥，另一个只有所有者知道，称作私钥，用公钥加密的信息必须用私钥才能解开，反之，用私钥加密的信息只有用公钥才能解开。用在信息安全传输和数字签名场合，如RSA算法，实际使用中，常常会混合对称加密和非对称加密，有时也会使用两次非对称加密


**秒杀系统**

此功能一些问题

1. 对现有网站业务造成冲击
2. 高并发下的应用，数据库负载
3. 突然增加的网络及服务器带宽
4. 直接下单

秒杀系统的应对策略

1. 秒杀系统独立部署，不要因为秒杀系统拖垮整个网站
2. 秒杀商品页面静态化，设计秒杀商品页面，页面内容静态化，用户不需要经过应用服务器的业务逻辑单元，也不访问数据库
3. 租借秒杀活动网络带宽，将秒杀商品页面缓存在CDN
4. 动态生成随机下单页面URL，秒杀系统的开发者也无法在秒杀前访问下单页面的URL
