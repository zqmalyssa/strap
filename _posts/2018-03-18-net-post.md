---
layout: post
title: "路由器、交换机、防火墙等网络设备"
author-id: "zqmalyssa"
tags: [compute, network]
---

计算机中网络相关的学习真的是非常有用，但也很难，需要形成一个体系，对路由器，交换机，防火墙等有最基本的认识，再不断补充

### 一、路由器

首先要了解一些路由器的基本知识

1. 网络部分相同的IPv4地址，可以认为它们归属同一子网
2. 单播，广播（使用255.255.255.255或主机部分全为1的地址，如192.168.1.255/24），多播，任播（只在IPv6中有）
3. IPv6增加到了128bit，用冒号将地址分成8个部分，每个部分长16bit，使用16进制数字表示，IPv6有条简写规则，即前导并连续的0可以省略
4. 每个地址块中前导并连续的0可以省略，全为0的地址块保存一个0，单个连续的只有0组成的地址可以用": :"来替代（但整个地址中只能有一个": :"），IPv4个人计算机一般标记为"127.0.0.1"，IPv6一般标记为"::1"
5. ARP是通过IPv4地址获取MAC地址的网络协议
6. DHCP服务包括三个功能，DHCP服务器功能、DHCP客户端功能，DHCP中继代理功能，获取Ip的方式有4步，客户端对网段内广播DHCPDISCOVER消息，DHCP服务器在网络内广播DHCPOFFER消息，客户端在网络内广播DHCPREQUEST消息，在接收了DHCPACK消息后，客户端就能使用所分配的IP地址

ip隧道与VPN

某个通信协议被其他通信协议封装后进行转发传输的技术称为隧道技术。在处于网络上的**两台路由器**之间设置隧道的话，就可以在路由器之间根据隧道协议构建一条虚拟的通信链路，路由器A接受的原始分组以封装后的形态通过隧道协议被转发到目的地路由器B中。路由器B随后进行解封装，还原分组形态，并以原始形态再次转发到实际的目的地。

由于该技术架设直连通信两地的隧道（虚拟的），因此也称为隧道技术。

隧道协议有类似L2F，PPTP，L2TP这样将数据链路层数据封装于IP分组中的L2隧道协议，还有类似GRE，IPSec这样将网络层分组封装于IP分组中的L3隧道协议，隧道协议多用于构建VPN（Virtual Private Network，虚拟私有网）网络，尤其是使用IPsec构建加密的VPN提供给用户。这时，PC-A和PC-B之间分配的私有地址处于一个网络中，而路由器A和路由器B之间则使用全局地址，在互联网上相连并负责数据的传输。

路由冗余的种类，主备方式（Active-Standby），双活方式（Active-Active），集群方式（Cluster），使用主备方式时，会使用类似VRRP的冗余协议，

VRRP协议（Virtual Router Redundancy Protocol，虚拟路由冗余协议），用于路由器的冗余和复用（想想Keepalived吧），通过该协议，可以将多台路由器组成1个群组，其中1台为活跃设备，其余为备用设备。与此同时，1台路由器既可以属于多个群组，也可以设置成为双活方式，组成N+1的冗余结构。位于同一个群组的路由器之间使用224.0.0.18的组播地址进行通信，交互协议号为112的VRRP控制分组。默认状态时，主设备每隔1秒向群组内的成员发送VRRP通知信息，如果在3秒内群组没有收到来自主设备的消息则判断主设备已经发生故障（想想keepalived的配置），使用多播地址224.0.0.18发送VRRP通告，以1秒为间隔

隧道协议可以分为二层隧道协议和三层隧道协议，其中二层就在数据链路层，它使用帧作为数据的交换单位，也就是说将数据封装在点对点协议（PPP）帧中，而三层隧道协议在网络层中，使用包作为数据交换单位，它将IP包封装在附加的IP包头中通过IP网络互相传送

### 二、交换机

首先要了解一些交换机的基本知识

L3交换机是一种在L2交换机的基础上增加了路由选择功能的网路硬件，能够通过基于ASIC和FPGA的硬件处理高速实现网络功能和转发分组。L2交换机能够基于数据链路层编制的MAC地址，进行数据帧或VLAN的传输工作，L3交换机能够基于位于网络层的IP首部信息，实现路由选择以及分组过滤等功能。

L2交换机可以通过使用VLAN分割广播域，但终端之间的数据帧交换必须位于同一VLAN范围内。对位于不同VLAN上的终端如有通信需求时，则必须使用路由功能，因此需要在网络上额外添加路由器。**L2交换机与路由器组合才能完成跨VLAN的通信，但使用L3交换机则无需其他硬件设备，能够直接完成VLAN的配置和VLAN之间的通信**。现在，越来越多组织的内部网络核心交换机采用L3交换机，L3交换机多用于在由以太网构筑的Intranet内部转发分组，而路由器则大多作为连接互联网和Intranet内网之间的网关来使用。

L3交换机由控制平面（基于CPU的软件处理进行硬件整体控制，负责操作系统管理，管理员用户界面，路由选择协议处理等工作），数据平面（基于ASIC、FPGA、网络处理器的硬件处理来进行实际的数据传输），背板，物理接口（如常见的RJ-45）

除L2交换机外，拥有L3以上功能的交换机统称为多层交换机或高层交换机，能够支持到TCP层级访问控制的交换机称为L4交换机，甚至有些产品能够基于HTTP和HTTPS这类应用层（L7）参数进行负载均衡操作，这类产品可以称为L7交换机，有些厂商将处理到该层的产品与之前的路由器区分开来，作为不同类型的产品进行销售。但所谓的多层交换机，也就是通过基于ASIC或FPGA的硬件处理，来高速进行各层相关业务处理的网络硬件。

这边就要说到**负载均衡器**，其可以是专用设备，也可以是在通用服务器上运行的应用程序。专用设备一般只有以太网接口，**可以说是多层交换机的一种**。也存在拥有分组负载均衡功能的路由器。设备类的如F5 Networks公司的BIG-IP系列，A10 Networks公司的AX系列。负载均衡的几种算法要了解，常见的是轮询（Round Robin），最少连接（Least Connections），加权轮询（Weighted Round Robin），加权最少连接（Weighted Least Connections），IP地址散列，URL散列。

SSL加速是负载均衡设备提供的功能之一，执行该功能的设备内部装置称为SSL加速器。因为SSL通信时候的加密解密比较耗时，通过SSL加速器，对来自客户端的HTTPS请求解密，将其转换为HTTP请求后再转发至实际的服务器上，这样就可以降低服务器CPU的处理负载

高端L3交换机（一般是机框式的），作为企业的**核心交换机**用于数据中心或服务提供商，中端L3交换机（箱式或最大槽数是4的机框交换机），用于将企业的核心交换机和边缘交换机进行汇聚交换，低端L3交换机（箱式交换机或桌面式交换机），作为企业的接入交换机（边缘交换机）

**VLAN**需要熟悉，由1台或者多台交换集线器所组成的1个广播域可以称为是一个**扁平网络（flat network）**。该网络只由L2组成，相互连接的硬件会接收所有网络发来的广播帧，因此，随着连接硬件数量的增加，广播数量也会增加，网络状况也就越发混杂。这种情况下需要采用能够将整个扁平网络进行逻辑分段的VLAN（Virtual LAN）技术。各个VLAN均使用同1个广播域，因此能够控制该域内广播通信的规模（一个交换机下有多个广播域）。交换机通过设置（configuration）能够轻易更改物理端口的属性，使该物理端口附加某个VLAN之中，因此当连接交换机的用户终端发生变化时，也无需更改所对应的物理配线。**VLAN之间的通信需要使用路由选择**，不借助路由器无法与不同VLAN的终端进行通信，因此安全性有可保障。

1. 基于端口的VLAN是指在一台交换机上完成VLAN的构建功能，在交换机上设置VLAN ID信息，将拥有相同VLAN ID的多个端口构成一个VLAN，交换机在初始状态所有端口默认VLAN ID=1，但是使用者可以对任意一个端口进行VLAN ID=2的设置

2. 标签VLAN，**用在需要跨多个交换机创建VLAN时**，一般会用到使用中继端口（trunk port）的标签VLAN（tag VLAN），标签VLAN通过中继端口完成以太网数据帧的收发，以太网需添加4字节IEEE 802.1Q所定义的首部（即VLAN标签信息），包含12bit的VLAN ID，所以最多支持的VLAN数是4096个

3. 本征VLAN，编号为1的VLAN，一般用于管理VLAN，所以最好使用2以上的数值作为新建VLAN的ID

4. 中继端口，向其他交换机传递VLAN编号时，首先需要设置中继端口（trunk port），两台交换机中继端口之间的链路称为中继链路（trunk link）

**交换机接受到来自主机的ARP请求后，在MAC地址表中记录下主机A的信息，由于ARP请求为广播地址，因此交换机会向除接收端口之外的所有端口复制数据帧并进行扩散（flooding），但在VLAN环境下，只有和主机同属于一个VLAN的端口会被扩散到**

**VLAN之间转发数据，一般会使用中继链路连接路由器，通过路由器记性VLAN之间的路由选择，L3交换机内部直接完成VLAN之间的路由选择**

**补充网桥的内容**
网桥（Bridge）是早期的两端口二层网络设备，用来连接不同网段。网桥的两个端口分别有一条独立的交换信道，不是共享一条背板总线，可隔离冲突域。网桥比集线器（Hub）性能更好，集线器上各端口都是共享同一条背板总线的。后来，网桥被具有更多端口、同时也可隔离冲突域的交换机（Switch）所取代。扩展局域网最常见的方法是使用网桥。最简单的网桥有两个端口，复杂些的网桥可以有更多的端口。网桥的每个端口与一个网段相连。网络1和网络2通过网桥连接后，网桥接收网络1发送的数据包，检查数据包中的地址，如果地址属于网络1，它就将其放弃，相反，如果是网络2的地址，它就继续发送给网络2。这样可利用网桥隔离信息，将同一个网络号划分成多个网段（属于同一个网络号），隔离出安全网段，防止其他网段内的用户非法访问。由于网络的分段，各网段相对独立（属于同一个网络号），一个网段的故障不会影响到另一个网段的运行


### 三、防火墙

防火墙有软件型防火墙和硬件型防火墙之分，其中，软件型中有个人防火墙，运行于个人计算机中，用于监控个人计算机与外部网络之间的通信信息，还有网关型防火墙，在计算机网络的网关中设置类似防火墙设备的功能，从而对网络中通信流量进行策略控制，一类是在windows和linux等通用操作系统上安装运行FireWall-1软件和软件型网关防火墙，一类是使用专用设备的硬件型网关防火墙。硬件型防火墙是指通过硬件设备实现的防火墙，外形同路由器形状类似，但网络接口类型一般只支持以太网。

大多数的防火墙中都有安全区域（Security Zone，简称为区域）的概念，即将防火墙上物理接口以及逻辑接口分配至不同的区域中，也就是将与防火墙连接的网段分别划分到不同的区域中，其中，一个网络接口不能属于多个区域。在同一区域内可以自由进行基本通信，但跨区域的通信必须符合安全策略才能完成，防火墙也能够通过安全策略设置发送源或发送目的地等条件，根据是否符合这些条件来判断位于同一区域内的通信是否可行。

**比如互联网被认为Untrust区域，公开服务器被认为DMZ区域(DeMilitarized Zone，非武装区域，DMZ是指由防火墙划分、放置了对外公开服务器的网段，该区域与内部网络是分离开的)，内部网络被认为Trust区域，销售群组网络被认为Sales区域，Trust区域分配Ethernet1、tunnel1、loopback1，Untrust区域分配Ethernet1/2，DMZ分配Ethernet1/5，Sales分配Ethernet1/3**

防火墙的主要功能就是访问控制，通过设置“规则”来实现，每一条规则都指定了需要控制的发送源、目的地以及通信内容等信息。在路由器中，这类访问控制的规则集合称为“访问控制列表”，而在防火墙中则一般称为“安全策略”或“安全规则”，防火墙的安全策略与路由器最大不同就是是否拥有区域的概念，大多数防火墙使用区域作为触发对象，新一代防火墙触发对象还包括应用程序名称和用户名称等信息。防火墙安全示例中并没有从Trust区域向DMZ区域进行通信的表项，对于这类没有出现在安全策略表中的通信行为，防火墙默认执行拒绝的行为。这一决策称为“默认的拒绝”，可设置的安全策略有一定的上限，表项越多，性能也会随之下降。

NAT是通过路由器或防火墙将发送源的私有IP地址转换为全局IP地址，这一转换称为NAT。NAT原本是路由器提供的功能，现在位于网络边界处的防火墙也有此功能，运行该功能的路由器或防火墙一般称为网关（gateway），静态NAT是将NAT之前的地址和NAT之后的地址进行1:1分配，由管理员将信息设置到网关中。动态NAT首先给网关指定一个名为IP地址池的IP地址范围，也是存在1:1分配，但是动态NAT转换后的地址不是由管理员设置。发送源NAT，对发送源的IP地址进行NAT。目的NAT，对发送目的地的IP地址进行NAT。如果地址不够用，网关需要结合使用TCP或UDP的端口号，完成将多个私有地址映射成1个全局地址的转换。这种技术叫做NAPT（Network Address Port Translation），是动态NAT的一种。

路由器，防火墙，VPN专用装置都可以支持IPSec-VPN的功能，各个节点之间使用这些设备创建IPsec隧道并进行连接，就可以完成VPN的构建。还有一类是SSL-VPN，这类VPN就不需要安装客户端了，带Web浏览器即可，使用防火墙允许通过的HTTPS（TCP443）端口。IPSec在网络层实现，而SSL在会话层实现。

DOS攻击，即Denial of Service，无法继续提供服务，还有DDOS攻击，通过多个跳板攻击，制造远超过预先设计的访问量，从而使得被攻击的系统进入无法提供服务的状态。

防火墙防御功能，DOS防御功能，端口扫描防御（TCP端口扫描，UDP端口扫描，0-65535的端口号进行扫描）

### 四、CCNA补充

概念与上方重叠，补充了路由器，交换机的基本操作，很实用。
1. 理解基本内容后需要学习如何**划分子网，这部很关键**，简单的，复杂的，需要一眼看出子网号，掩码，网关，可用的主机，为后面做准备。理解变长子网（VLSM）
a.子网划分是在原本的主机段进行的，跟网络段没有任何关系
b.有A类地址子网划分，B类地址子网划分和C类地址子网划分
c.子网掩码有对应的CIDR值，/8-/15只用于A类网络，/16-/23可用于A类或者B类网络，/24-/30可用于A类、B类、C类网络，A类网络地址好啊，因为可使用所有的子网掩码，网络设计灵活。
d.块得概念，256-子网掩码就是块，从0开始根据块不断增加到掩码值就是所有子网，广播地址是下一个子网号的前一位，那么可使用主机是地址+1到下一个子网号的前两位
2. 思科网络的的一些基本配置
3. 学习IP路由，路由选择过程，路由选择协议，自己在路由器上配置路由
4. 2层交换机生成树（STP），在交换机上进行配置
5. VLAN的作用，在交换机上配置VLAN，端口为access和trunk，各应用在何处，思科的VTP机制
6. ACL的协议，在路由器上进行访问控制，了解常见的配置写法
7. NAT地址转换，3种方式
8. IPv6，三种改造方法，1双栈（都支持），26to4，包装成IPv4，3使用NAT-PT（不常用），最好还是改造成端到端的IPv6

### 五、网络的一些基础知识

1、HTTP的响应码

400是bad request，对应一些格式错误，如application/x-www-form-urlencoded使用上的问题
401是认证问题
