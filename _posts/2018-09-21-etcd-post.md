---
layout: post
title: "etcd使用及运维"
author-id: "zqmalyssa"
tags: [code, operations]
---

etcd在K8S的部署和使用中有很重要的作用，目前看etcd是可以独立进行安装和使用的，我们一起看看ectd的一些基本情况及相关运维

### ETCD的基本介绍

Etcd是一个采用HTTP协议的健/值对存储系统，它是一个分布式和功能层次配置系统，可用于构建服务发现系统。用于共享配置和服务发现的分布式,一致性的KV存储系统.其很容易部署、安装和使用，提供了可靠的数据持久化特性。它是安全的并且文档也十分齐全。
ETCD该项目目前最新稳定版本为3.3.9，ETCD是CoreOS公司发起的一个开源项目，授权协议为Apache.

提供配置共享和服务发现的系统比较多，其中最为大家熟知的是Zookeeper，而ETCD可以算得上是后起之秀了。在项目实现，一致性协议易理解性，运维，安全等多个维度上，ETCD相比Zookeeper都占据优势
**Zookeeper和etcd的区别：**
1）一致性协议： ETCD使用Raft协议， .Zookeeper使用ZAB（类PAXOS协议），前者容易理解，方便工程实现；
2）运维方面：ETCD方便运维，ZK难以运维；
3）项目活跃度：ETCD社区与开发活跃，ZK已经快死了；
4）API：ETCD提供HTTP+JSON, gRPC接口，跨平台跨语言，ZK需要使用其客户端；
5）访问安全方面：ETCD支持HTTPS访问，ZK在这方面缺失；

Etcd的应用场景：
配置管理，服务注册于发现，选主，应用调度，分布式队列，分布式锁

Etcd 主要提供以下能力:
1)提供存储以及获取数据的接口，它通过协议保证Etcd集群中的多个节点数据的强一致性。用于存储元信息以及共享配置。
2)提供监听机制，客户端可以监听某个key或者某些key的变更（v2和v3的机制不同，参看后面文章）。用于监听和推送变更。
3)提供key的过期以及续约机制，客户端通过定时刷新来实现续约（v2和v3的实现机制也不一样）。用于集群监控以及服务注册发现。
4)提供原子的CAS（Compare-and-Swap）和 CAD（Compare-and-Delete）支持（v2通过接口参数实现，v3通过批量事务实现）。用于分布式锁以及leader选举。

Etcd的工作原理：
ETCD使用Raft协议来维护集群内各个节点状态的一致性。简单说，ETCD集群是一个分布式系统，由多个节点相互通信构成整体对外服务，每个节点都存储了完整的数据，并且通过Raft协议保证每个节点维护的数据是一致的。每个ETCD节点都维护了一个状态机，并且，任意时刻至多存在一个有效的主节点。主节点处理所有来自客户端写操作，通过Raft协议保证写操作对状态机的改动会可靠的同步到其他节点。

ETCD使用RAFT协议保证各个节点之间的状态一致。根据RAFT算法原理，节点数目越多，会降低集群的写性能。这是因为每一次写操作，需要集群中大多数节点将日志落盘成功后，Leader节点才能将修改内部状态机，并返回将结果返回给客户端。
也就是说在等同配置下，节点数越少，集群性能越好。显然，只部署1个节点是没什么意义的。通常，按照需求将集群节点部署为3，5，7，9个节点。Etcd官方给出了节点数目与failover能力的对应关系图
这里能选择偶数个节点吗？ 最好不要这样。原因有二：
1)偶数个节点集群不可用风险更高，表现在选主过程中，有较大概率或等额选票，从而触发下一轮选举。
2)偶数个节点集群在某些网络分割的场景下无法正常工作。试想，当网络分割发生后，将集群节点对半分割开。此时集群将无法工作。按照RAFT协议，此时集群写操作无法使得大多数节点同意，从而导致写失败，集群无法正常工作。

Etcd v3版本和以前的v2在使用和操作上面还是有些区别的，像v2版本的ls命令就没有了，K8S不知道哪个版本开始是调用V3版本进行数据写入的，Etcd v2 和 v3 本质上是共享同一套 raft 协议代码的两个独立的应用，接口不一样，存储不一样，数据互相隔离。也就是说如果从Etcd v2升级到 Etcd v3，原来v2的数据还是只能用v2的接口访问，v3的接口创建的数据也只能访问通过v3的接口访问。所以我们按照v2和v3分别分析所以使用前需要设置下

```html
# export ETCDCTL_API=3
```
然后就能进行查看了

```html
# etcdctl get / --prefix --keys-only
```
理解K8S的句知道使用如下命令来查看集群中的deployment资源

```html
# etcdctl get /registry/deployments/default --prefix --keys-only
```
然后get查看key的值信息，del删除这个key

### ETCD的运维

**1.三台机器，某一次卡机后，检查etcd组件崩了，第一个启动的机器怎么也不能重启etcd了，表现情况**

![etcdfail2]({{ "/assets/img/etcd/fail2.jpg" | relative_url}})

```html
# systemctl restart etcd
```
这些操作无用，所以采用重来大法

```html
# systemctl stop etcd && rm -rf /var/lib/etcd
# systemctl restart etcd
```
发现报错不一样了

![etcdfail1]({{ "/assets/img/etcd/fail1.jpg" | relative_url}})

想应该是需要有重启顺序，所以，在别的节点上分别进行重来大法，然后在重新按序启动etcd即可

**2.etcd单机点**

etcd的单机点跟集群部署类似，先创建认证，主要是将某些集群的配置全部去除，结果集群状态ok，成员状态ok